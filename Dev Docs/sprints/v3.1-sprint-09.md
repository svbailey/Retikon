# V3.1 Sprint 09 - Query performance acceleration

Dates: TBD
Owner: TBD

## Goal
Reduce multimodal tail latency with optimized runtimes and tiered query services.

## Phase 0 decisions (locked on 2026-01-29)
- Modalities (v1): text (BGE), image-text (CLIP text), audio-text (CLAP text)
  for query; audio (CLAP audio) for ingestion. Defer CLIP image ONNX unless
  image-only query speed is explicitly required.
- Quantization (v1): dynamic INT8 for text encoders only (BGE + CLIP text).
  Audio remains FP32 ONNX.
- Quality gates:
  - Cosine similarity vs HF: text + CLIP text >= 0.98, audio >= 0.97.
  - Quantized text similarity >= 0.95.
  - Retrieval sanity: top-10 overlap >= 90% vs HF on a small validation set.
- Performance gates (CPU tier):
  - Text p50 >= 25% faster vs HF baseline.
  - Text p95 >= 20% faster vs HF baseline.
  - p99 < 10s at QPS 10 / concurrency 20.
  - Error rate <= 0.5% (timeouts included).
- Dependency policy: onnxruntime in Pro container only; Core optional with tests
  skipped when onnxruntime is absent.
- Fail-fast: if EMBEDDING_BACKEND=onnx|quantized and ONNX models are missing,
  raise a runtime error (no silent HF fallback).

## Scope checklist (Core)
- [ ] Add ONNX/quantized embedding backends in `retikon_core/embeddings/`.
- [ ] Add routing hooks/interfaces in `retikon_core/query_engine/` (no GPU tiers enabled).

## Scope checklist (Pro)
- [ ] Add GPU query service profile/entrypoint in `gcp_adapter/`.
- [ ] Deploy GPU services via `infrastructure/terraform/`.

## Scope checklist (Docs)
- [ ] Add SLO load tests for text-only vs multimodal queries in
      `Dev Docs/pro/Load-Testing.md`.

## Primary paths (Core)
- `retikon_core/embeddings/`
- `retikon_core/query_engine/`

## Primary paths (Pro)
- `gcp_adapter/`
- `infrastructure/terraform/`

## Primary paths (Docs)
- `Dev Docs/pro/Load-Testing.md`

## Tests and validation
- [ ] Core: `tests/core/test_embedding_backends.py`
- [ ] Core: `tests/core/test_query_routing.py`
- [ ] Pro: `tests/pro/test_query_tiers.py` (new)

## Deliverables
- [ ] CPU-optimized (ONNX/quantized) and GPU query tiers available in Pro.
- [ ] Documented routing rules and performance baselines.

## Risks / Dependencies
- [ ] Requires GPU-capable build pipeline and cost controls.

## Notes
-
